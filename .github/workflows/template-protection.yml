name: Template Protection

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  validate-template-purity:
    runs-on: ubuntu-latest
    name: Validate Mastermind Template Purity
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for .templatelock
        run: |
          if [ ! -f ".templatelock" ]; then
            echo "‚ùå ERROR: .templatelock file missing!"
            echo "Mastermind must remain a template engine."
            exit 1
          fi
          echo "‚úÖ .templatelock present"
      
      - name: Check for service-specific code
        run: |
          # Fail if service-specific directories exist
          if [ -d "src/services" ] && [ "$(ls -A src/services)" ]; then
            echo "‚ùå ERROR: Service-specific code detected in src/services/"
            echo "Mastermind should not contain actual service implementations."
            exit 1
          fi
          echo "‚úÖ No service-specific code detected"
      
      - name: Validate template structure
        run: |
          required_dirs=("templates" "src/agents")
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "‚ùå ERROR: Required directory $dir is missing"
              exit 1
            fi
          done
          echo "‚úÖ Template structure valid"
      
      - name: Check TEMPLATE.md exists
        run: |
          if [ ! -f "TEMPLATE.md" ]; then
            echo "‚ùå ERROR: TEMPLATE.md is missing"
            echo "This file documents Mastermind's template philosophy."
            exit 1
          fi
          echo "‚úÖ TEMPLATE.md present"
      
      - name: Validate no production dependencies
        run: |
          # Check package.json for service-specific dependencies
          if grep -q "express" package.json && grep -q "\"dependencies\"" package.json; then
            echo "‚ö†Ô∏è  WARNING: Production server dependencies detected"
            echo "Mastermind should only have dev/generation dependencies."
            # Don't fail, just warn for now
          fi
          echo "‚úÖ Dependency check complete"
      
      - name: Success message
        run: |
          echo "üéâ Template protection validated!"
          echo "Mastermind remains a pure template engine."